# Федеративное обучение рекомендательной системы

НИР: обучение рекомендательной модели на данных нескольких компаний без обмена сырыми данными.

## Идея

Есть 20 компаний (клиентов), у каждой — свои пользователи и рейтинги фильмов. Данные конфиденциальны и не должны покидать «железо» клиента. При этом есть публичные данные (50% юзеров), доступные всем клиентам. Каждый клиент обучает гибридную NCF-модель локально и отправляет на сервер обновления shared-параметров. Приватные эмбеддинги пользователей остаются локальными — сервер их не видит.

## Архитектура

- **Модель**: HybridNCF — GMF + MLP с разделением на публичные и приватные user embeddings
- **FL-фреймворк**: Flower (FedAvg стратегия)
- **Датасет**: MovieLens-1M (6040 юзеров, 3706 фильмов, 1M рейтингов)
- **Распределение**: гибридное — 50% публичных юзеров (все клиенты) + 50% приватных (non-IID по жанрам + Dirichlet)

### Гибридный Partial FedAvg

Агрегируются через FedAvg:
- Публичные user embeddings (одинаковые юзеры на всех клиентах)
- Item embeddings (все фильмы глобальные)
- MLP + output слои (общие паттерны взаимодействия)

Остаются локальными:
- Приватные user embeddings (у каждого клиента свои уникальные юзеры)

## Запуск

```bash
pip install -r requirements.txt

# 1. Скачать данные и разбить на 20 клиентов
python scripts/prepare_data.py

# 2. Обучить baseline (централизованно, все данные в одном месте)
python scripts/train_centralized.py

# 3. Запустить FL-симуляцию
python scripts/run_simulation.py
```

Результаты сохраняются в `data/processed/`. Графики и анализ — в `notebooks/experiments.ipynb`.

## Структура

```
src/
  data/        — скачивание ML-1M, гибридное non-IID разбиение на клиентов
  models/      — NCF и HybridNCF с разделением shared/local параметров
  federated/   — Flower клиент и сервер (partial FedAvg)
  utils/       — метрики (RMSE, MAE, HR@K, NDCG@K)
scripts/       — точки входа (prepare_data, train_centralized, run_simulation)
configs/       — config.yaml со всеми параметрами
notebooks/     — jupyter с визуализацией результатов
```

## Конфигурация

Все параметры в `configs/config.yaml`. Скрипты читают его автоматически.

## Метрики

- **RMSE / MAE** — ошибка предсказания рейтинга
- **HR@K** — попал ли правильный фильм в top-K рекомендаций (negative sampling, 99 негативов)
- **NDCG@K** — качество ранжирования с учётом позиции

## Результаты

| Метрика | Централизованное | Федеративное (гибрид) | Δ |
|---------|-----------------|----------------------|---|
| RMSE | 0.888 | 0.865 | **-2.6%** |
| MAE | 0.703 | 0.683 | **-2.8%** |
| HR@10 | 0.343 | 0.290 | -16% |
| NDCG@10 | 0.183 | 0.150 | -18% |

Гибридная FL-модель **превосходит** централизованную по RMSE/MAE за счёт публичных данных + агрегации item-эмбеддингов. По ранкинговым метрикам разрыв ~16-18% — значительно меньше, чем при чисто non-IID FL (~40%).

Per-client RMSE: 0.860–0.869 — очень стабильные результаты по всем клиентам.
